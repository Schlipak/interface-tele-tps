"use strict";function NetworkInterface(newMeta){this.currentElement=void 0,this.hoverElement=void 0;var container=$("#mainCanvas");this.width=container.width(),this.height=container.height(),this.tp=void 0,this.timeSinceLastClick=1e3;var th=this;container.empty(),$.getJSON("config.json",function(data){th.networkObjectList=data.networkObjectList,th.softwareList=data.softwareList}),this.svg=d3.select("#mainCanvas").append("svg").attr("id","mainSvg").attr("width",this.width).attr("height",this.height).on("dragover",function(){d3.event.preventDefault()}).on("drop",function(){d3.event.preventDefault();var index=d3.event.dataTransfer.getData("index");index>=0&&th.add(parseInt(index),d3.mouse(this)[0],d3.mouse(this)[1])}),this.g=this.svg.append("g");var jMainSvg=$("#mainSvg").attr("xmlns:svg","http://www.w3.org/2000/svg");jMainSvg.attr("xmlns:xlink","http://www.w3.org/1999/xlink"),th.tp=new TP(newMeta)}NetworkInterface.prototype.resize=function(h,w){var jMainCanvas=$("#mainCanvas");this.height=h||jMainCanvas.height(),this.width=w||jMainCanvas.width(),d3.select("#mainSvg").attr("height",this.height).attr("width",this.width),void 0!==this.tp&&(this.tp.resetFixed(),this.update())},NetworkInterface.prototype.getCurrentNode=function(){return this.currentElement},NetworkInterface.prototype.deleteConnection=function(endpoint){this.currentElement.deleteInterfaceByEndpoint(endpoint),this.tp.getEndpoint(endpoint).deleteInterfaceByEndpoint(this.currentElement),this.update(),angular.element($("#settingsForm")).scope().reset()},NetworkInterface.prototype.downloadImage=function(){var th=this,html=d3.select("svg").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,imgsrc="data:image/svg+xml;base64,"+btoa(html),canvas=document.querySelector("canvas");canvas.height=5*this.height,canvas.width=5*this.width;var context=canvas.getContext("2d");context.clearRect(0,0,canvas.width,canvas.height);var image=new Image;image.src=imgsrc,image.onload=function(){context.drawImage(image,0,0,canvas.width,canvas.height),canvas.toBlob(function(blob){saveAs(blob,th.tp.getMeta().experiment.name+".png")})}},NetworkInterface.prototype.downloadSvg=function(){var html=d3.select("svg").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,blob=new Blob([html],{type:"data:image/svg+xml;charset=utf-8"});saveAs(blob,this.tp.getMeta().experiment.name+".svg")},NetworkInterface.prototype.downloadConfig=function(){var blob=new Blob([this.tp.toJson()],{type:"text/json;charset=utf-8"});saveAs(blob,this.tp.getName()+".json")},NetworkInterface.prototype.add=function(i,x,y){var no=this.networkObjectList[i],softwareCompliant=no.softwareCompliant||!1,res=new Resource(no.type,no.name+(this.tp.getResourceSize()+1),softwareCompliant,no["function"],i);void 0!==x&&void 0!==y&&res.setPosition(x,y),this.tp.addResource(res),this.update()},NetworkInterface.prototype.update=function(){function tick(){edges.attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y}),node.attr("x",function(d){return d.x-25}).attr("y",function(d){return d.y-25}),labels.attr("transform",function(d){return"translate("+d.x+","+d.y+")"})}function mouseup(){var tpCreatorCanvasScope=$("#tpCreatorCanvas");if((new Date).getTime()-th.timeSinceLastClick<=250)th.svg.on("mousemove",null),d3.event.preventDefault(),toggle=!1,th.g.selectAll(".tempLine").remove(),$(".tempLine").remove(),angular.element(tpCreatorCanvasScope).scope().showSidebar(tpCreatorCanvasScope.scope().TAB.SETTINGS),angular.element(tpCreatorCanvasScope).scope().reset(),angular.element(tpCreatorCanvasScope).scope().$apply();else if(th.timeSinceLastClick=(new Date).getTime(),0===d3.event.button){var m=d3.mouse(this);if(line=th.g.append("line").attr("class","tempLine").attr("x1",m[0]).attr("y1",m[1]).attr("x2",m[0]).attr("y2",m[1]).style("stroke","#0f9d58").style("stroke-width",1),toggle)if(toggle=!1,th.svg.on("mousemove",null),null!==th.hoverElement&&void 0!==th.hoverElement){line.attr("class","line");try{var startpoint=startElement,endpoint=th.hoverElement;startpoint.equals(endpoint)||("switch"!==startpoint.getType()&&startpoint.addInterface(new Interface(endpoint,!0)),"switch"!==endpoint.getType()&&endpoint.addInterface(new Interface(startpoint,!0)),angular.element(tpCreatorCanvasScope).scope().reset(),angular.element(tpCreatorCanvasScope).scope().$apply(),th.update())}catch(ex){th.g.selectAll(".tempLine").remove(),$(".tempLine").remove()}}else th.g.selectAll(".tempLine").remove(),$(".tempLine").remove();else if(null!==th.hoverElement)toggle=!0,startElement=th.hoverElement,th.svg.on("mousemove",mousemove);else{var settingsFormScope=angular.element($("#settingsForm")).scope();settingsFormScope.hideSidebar()}}}function mousemove(){var m=d3.mouse(this);line.attr("x2",m[0]-1).attr("y2",m[1]-1)}var line,startElement,th=this,toggle=!1;this.g.selectAll("*").remove();var defs=this.g.append("defs"),filter=defs.append("filter").attr("id","dropshadow").attr("height","130%");filter.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3),filter.append("feOffset").attr("dx",2).attr("dy",2).attr("result","offsetblur");var feMerge=filter.append("feMerge");feMerge.append("feMergeNode"),feMerge.append("feMergeNode").attr("in","SourceGraphic");var node_drag=(self.force=d3.layout.force().nodes(this.tp.getNodes()).links(this.tp.getLinks()).size([this.width,this.height]).linkDistance([250]).charge([-1500]).gravity(.3).on("tick",tick).start(),d3.behavior.drag().on("dragstart",function(d){d.fixed=!0}).on("dragend",function(d){d.fixed=!0,tick()}).on("drag",function(d){th.svg.on("mouseup",null),d3.event.x>=th.width?d.x=th.width:d3.event.x<=0?d.x=0:d.x+=d3.event.dx,d3.event.y>=th.height?d.y=th.height:d3.event.y<=0?d.y=0:d.y+=d3.event.dy,d.px=d.x,d.py=d.y,tick()})),edges=this.g.selectAll("line").data(this.tp.getLinks()).enter().append("line").style("stroke","#999").style("stroke-width",1),elem=this.g.selectAll("g").data(this.tp.getNodes()).enter().append("g"),node=elem.append("image").attr("width",50).attr("height",50).attr("xlink:href",function(d){return th.networkObjectList[d.getNetworkObjectIndex()].image}).on("mousedown",function(d){th.currentElement=d,th.g.selectAll("image").style("filter",""),d3.select(this).style("filter","url(#dropshadow)"),th.g.selectAll("image").sort(function(a,b){return a.id!=d.id?-1:1})}).on("click",function(d){th.currentElement=d,th.svg.on("mouseup",mouseup)}).on("mouseenter",function(d){th.hoverElement=d}).on("mouseleave",function(){th.hoverElement=null}).on("contextmenu",function(){d3.event.preventDefault(),d3.event.stopPropagation();var tpCreatorCanvasScope=angular.element($("#tpCreatorCanvas")).scope();tpCreatorCanvasScope.showSidebar(tpCreatorCanvasScope.TAB.SETTINGS),tpCreatorCanvasScope.reset(),tpCreatorCanvasScope.$apply()}).call(node_drag),labels=elem.append("text").attr("dy","40").attr("fill","black").attr("font-family","sans-serif").attr("font-size","14px").attr("text-anchor","middle").text(function(d){return d.id});th.svg.on("mouseup",mouseup),th.svg.on("contextmenu",function(){th.hoverElement=null,d3.event.preventDefault();var settingsFormScope=angular.element($("#settingsForm")).scope();settingsFormScope.showSidebar(settingsFormScope.TAB.NEW)})};